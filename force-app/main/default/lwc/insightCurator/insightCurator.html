<!-- sldsValidatorIgnore -->
<template>
    <lightning-card title="Insight Curator" icon-name="custom:custom63">
        <!-- Input Section -->
        <div class="slds-var-p-around_medium">
            <lightning-textarea
                label="Describe what you want to find"
                value={prompt}
                onchange={handlePromptChange}
                placeholder="e.g., Show open insights with likelihood >= 0.7 for EDGE Product X sorted by rank"
                required
            ></lightning-textarea>
        </div>

        <!-- Model Selection and Action Buttons -->
        <div class="slds-var-p-horizontal_medium slds-var-p-bottom_medium">
            <div class="slds-grid slds-gutters slds-wrap">
                <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2">
                    <lightning-combobox
                        label="AI Model"
                        value={selectedModel}
                        placeholder="Select a model"
                        options={modelOptions}
                        onchange={handleModelChange}
                    ></lightning-combobox>
                </div>
                <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-grid slds-grid_align-end">
                    <lightning-button
                        variant="brand"
                        label="Search"
                        title="Search Insights"
                        icon-name="utility:search"
                        onclick={handleSubmit}
                        disabled={isSubmitDisabled}
                        class="slds-m-top_large"
                    ></lightning-button>
                </div>
            </div>
        </div>

        <!-- Example Queries -->
        <template if:true={showExamples}>
            <div class="slds-var-p-horizontal_medium slds-var-p-bottom_small">
                <p class="slds-text-title_caps slds-text-color_weak slds-var-m-bottom_x-small">
                    Example Queries:
                </p>
                <div class="slds-grid slds-wrap slds-gutters_x-small">
                    <template for:each={exampleQueries} for:item="example">
                        <div key={example} class="slds-col">
                            <lightning-button
                                label={example}
                                title={example}
                                onclick={handleExampleClick}
                                data-query={example}
                                variant="neutral"
                                class="slds-var-m-bottom_x-small"
                            ></lightning-button>
                        </div>
                    </template>
                </div>
            </div>
        </template>

        <!-- Loading Spinner -->
        <template if:true={loading}>
            <div class="slds-var-p-around_medium slds-align_absolute-center">
                <lightning-spinner 
                    alternative-text="Processing your query..." 
                    size="medium"
                ></lightning-spinner>
                <p class="slds-text-align_center slds-var-m-top_small slds-text-color_weak">
                    Processing your query with AI...
                </p>
            </div>
        </template>

        <!-- Error Message -->
        <template if:true={errorMessage}>
            <div class="slds-var-p-around_medium">
                <div class="slds-notify slds-notify_alert slds-theme_error" role="alert">
                    <span class="slds-assistive-text">Error</span>
                    <h2>
                        <lightning-icon 
                            icon-name="utility:error" 
                            size="x-small" 
                            alternative-text="Error"
                            class="slds-var-m-right_x-small">
                        </lightning-icon>
                        {errorMessage}
                    </h2>
                </div>
            </div>
        </template>

        <!-- Success Message with Query Info -->
        <template if:true={showResults}>
            <div class="slds-var-p-horizontal_medium slds-var-p-bottom_small">
                <div class="slds-notify slds-notify_toast slds-theme_success" role="status">
                    <span class="slds-assistive-text">Success</span>
                    <lightning-icon 
                        icon-name="utility:success" 
                        size="x-small" 
                        variant="inverse"
                        class="slds-var-m-right_small"
                    ></lightning-icon>
                    <div class="slds-notify__content">
                        <h2 class="slds-text-heading_small">
                            Found {recordCount} record{recordCountPlural}
                        </h2>
                    </div>
                </div>
            </div>

            <!-- Generated SOQL Query (Expandable) -->
            <template if:true={generatedQuery}>
                <div class="slds-var-p-horizontal_medium slds-var-p-bottom_small">
                    <div class="slds-box slds-box_x-small slds-theme_shade">
                        <div class="slds-grid slds-grid_align-spread">
                            <p class="slds-text-title_caps slds-text-color_weak">
                                Generated Query
                            </p>
                            <lightning-button-icon
                                icon-name={queryToggleIcon}
                                alternative-text="Toggle query"
                                title="Toggle query visibility"
                                onclick={handleQueryToggle}
                                variant="bare"
                            ></lightning-button-icon>
                        </div>
                        <template if:true={showQuery}>
                            <div class="slds-m-top_x-small">
                                <code class="slds-text-body_small">{generatedQuery}</code>
                            </div>
                        </template>
                    </div>
                </div>
            </template>
        </template>

        <!-- Results Data Table -->
        <template if:true={showResults}>
            <div class="slds-p-around_medium">
                <lightning-datatable
                    key-field="Id"
                    data={results}
                    columns={columns}
                    hide-checkbox-column
                    show-row-number-column
                    onrowaction={handleRowAction}
                    min-column-width="80"
                    max-column-width="500">
                </lightning-datatable>
            </div>
        </template>

        <!-- Empty State -->
        <template if:false={hasSearched}>
            <div class="slds-p-around_large slds-align_absolute-center">
                <div class="slds-text-align_center">
                    <lightning-icon 
                        icon-name="utility:search" 
                        size="large"
                        class="slds-m-bottom_small"
                    ></lightning-icon>
                    <h3 class="slds-text-heading_medium slds-m-bottom_small">
                        Search Insights with Natural Language
                    </h3>
                    <p class="slds-text-color_weak">
                        Enter a query above to get started, or try one of the example queries.
                    </p>
                </div>
            </div>
        </template>
    </lightning-card>
</template>